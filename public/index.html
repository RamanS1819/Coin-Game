<!DOCTYPE html>
<html>
<body style="background:#333; display:flex; justify-content:center;">
  <canvas id="game" width="600" height="600"
    style="background:#000; border:2px solid #555; margin-top:20px;"></canvas>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const ws = new WebSocket(`ws://${location.host}`);

    let stateBuffer = [];

    // Must be > artificial latency, safer = 400ms
    const RENDER_DELAY = 400;

    ws.onmessage = (e) => {
      const msg = JSON.parse(e.data);

      if (msg.type === "state") {
        stateBuffer.push(msg);

        // Make buffer long enough so timestamps never outrun
        if (stateBuffer.length > 200) stateBuffer.shift();
      }
    };

    function sendMove(dx, dy) {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "move", dx, dy }));
      }
    }

    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowUp") sendMove(0, -1);
      if (e.key === "ArrowDown") sendMove(0, 1);
      if (e.key === "ArrowLeft") sendMove(-1, 0);
      if (e.key === "ArrowRight") sendMove(1, 0);
    });

    function lerp(a, b, t) {
      return a + (b - a) * t;
    }

    function renderFallback(latest) {
      // Draw coins
      ctx.fillStyle = "gold";
      latest.coins.forEach((c) => {
        ctx.beginPath();
        ctx.arc(c.x, c.y, 10, 0, Math.PI * 2);
        ctx.fill();
      });

      // Draw players
      for (let id in latest.players) {
        let p = latest.players[id];
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 20, 20);

        ctx.fillStyle = "white";
        ctx.fillText(`Score: ${p.score}`, p.x - 5, p.y - 10);
      }
    }

    function render() {
      ctx.clearRect(0, 0, 600, 600);

      const now = Date.now();
      const renderTime = now - RENDER_DELAY;

      let t0 = null, t1 = null;

      for (let i = 0; i < stateBuffer.length - 1; i++) {
        if (
          stateBuffer[i].timestamp <= renderTime &&
          stateBuffer[i + 1].timestamp >= renderTime
        ) {
          t0 = stateBuffer[i];
          t1 = stateBuffer[i + 1];
          break;
        }
      }

      if (!t0 || !t1) {
        // fallback: draw newest snapshot safely
        if (stateBuffer.length > 0) {
          renderFallback(stateBuffer[stateBuffer.length - 1]);
        }
        requestAnimationFrame(render);
        return;
      }

      const alpha =
        (renderTime - t0.timestamp) / (t1.timestamp - t0.timestamp);

      // --- draw coins from t1 (they do not move) ---
      ctx.fillStyle = "gold";
      t1.coins.forEach((c) => {
        ctx.beginPath();
        ctx.arc(c.x, c.y, 10, 0, Math.PI * 2);
        ctx.fill();
      });

      // --- draw interpolated players ---
      for (let id in t1.players) {
        let p1 = t1.players[id];
        let p0 = t0.players[id];

        if (!p0) continue;

        const x = lerp(p0.x, p1.x, alpha);
        const y = lerp(p0.y, p1.y, alpha);

        ctx.fillStyle = p1.color;
        ctx.fillRect(x, y, 20, 20);

        ctx.fillStyle = "white";
        ctx.fillText(`Score: ${p1.score}`, x - 5, y - 10);
      }

      requestAnimationFrame(render);
    }

    render();
  </script>
</body>
</html>
